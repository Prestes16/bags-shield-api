<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bags Shield API — Status & Playground</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#07172b; --bg-2:#0a1f3c; --card:#0e2748;
      --muted:#94a3b8; --text:#e6f1ff;
      --primary:#2fa7ff; --primary-2:#4dd4ff; --accent:#39ff88;
      --danger:#ff4d6d; --warn:#ffb020; --ok:#47d16a;
      --radius:20px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1600px 600px at 80% -10%, rgba(77,212,255,.18), transparent 60%),
        radial-gradient(1200px 500px at -10% 10%, rgba(47,167,255,.18), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg-2) 60%);
      min-height:100%;
    }
    a{color:var(--primary-2);text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .nav{display:flex;align-items:center;gap:14px}
    .logo{width:42px;height:42px;border-radius:14px;background: radial-gradient(80% 80% at 30% 25%, #2fa7ff 0%, #0e2748 60%);display:grid;place-items:center; box-shadow:var(--shadow)}
    .logo svg{width:24px;height:24px}
    .brand{font-weight:800;letter-spacing:.3px}
    .tag{font-size:12px;color:var(--muted);border:1px solid #1d3557;border-radius:999px;padding:3px 10px}
    .hero{margin-top:28px; border-radius:var(--radius); padding:28px; background:
        linear-gradient(140deg, rgba(15,74,121,.65), rgba(14,39,72,.65)); box-shadow:var(--shadow)}
    .hero h1{margin:0 0 10px 0;font-size:26px} .hero p{margin:0;color:var(--muted)}
    .cta-row{margin-top:16px;display:flex;gap:12px;flex-wrap:wrap}
    .btn{appearance:none;border:0;cursor:pointer;font-weight:700;padding:12px 16px;border-radius:14px;transition:.15s transform,.15s opacity}
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
    .btn-primary{background:linear-gradient(90deg,var(--accent),#6dffaa);color:#01230f}
    .btn-ghost{background:#0a2447;color:var(--primary-2);border:1px solid #12315a}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px;margin-top:22px}
    .card{grid-column: span 12;background:linear-gradient(180deg,rgba(20,54,96,.55),rgba(8,29,55,.7));border:1px solid #113057; border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
    .card h3{margin:0 0 8px 0;font-size:16px}
    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .pill{font-size:12px;border:1px solid #13406f;background:#0a2447;color:#cfe8ff;border-radius:999px;padding:6px 10px}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;font-weight:700}
    .b-ok{background:rgba(71,209,106,.12);color:#47d16a;border:1px solid rgba(71,209,106,.35)}
    .b-warn{background:rgba(255,176,32,.12);color:#ffcc66;border:1px solid rgba(255,176,32,.35)}
    .b-err{background:rgba(255,77,109,.12);color:#ff7e95;border:1px solid rgba(255,77,109,.35)}
    .io{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    textarea,input{width:100%; background:#061427;color:var(--text); border:1px solid #13325b; border-radius:12px; padding:10px; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:13px; outline:none}
    textarea:focus,input:focus{box-shadow: inset 0 0 0 1px var(--primary)}
    pre{white-space:pre-wrap;word-break:break-word;background:#061427;border:1px solid #13325b;border-radius:12px;padding:10px;font-size:13px;max-height:360px;overflow:auto;margin:0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .ghost{opacity:.8} .footer{margin:26px 0 10px 0;color:#6f87a7;font-size:12px;text-align:center}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:10px}
    @media (min-width: 860px){ .card.span-7{grid-column: span 7} .card.span-5{grid-column: span 5} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="logo" aria-label="Bags Shield logo">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 2l8 4v6c0 5-3.5 8.5-8 10-4.5-1.5-8-5-8-10V6l8-4z" stroke="url(#g1)" stroke-width="2" fill="rgba(17,48,87,.45)"/>
          <defs><linearGradient id="g1" x1="0" x2="1"><stop stop-color="#4dd4ff"/><stop offset="1" stop-color="#2fa7ff"/></linearGradient></defs>
        </svg>
      </div>
      <div class="brand">Bags Shield API</div>
      <span class="tag">v0.2.0 • navy/blue</span>
    </div>

    <div class="hero">
      <h1>Camada de Confiança para o ecossistema Bags</h1>
      <p class="ghost">Status em tempo real e playground para <code>/api/scan</code> e <code>/api/simulate</code>. Conecte o app, teste, quebre — e aprimore.</p>
      <div class="cta-row">
        <button id="btnHealth" class="btn btn-primary">Atualizar Status</button>
        <button id="btnPing" class="btn btn-ghost">Ping Bags (canário)</button>
      </div>
    </div>

    <div class="grid">
      <!-- Status -->
      <div class="card span-7">
        <h3>Status da API</h3>
        <div class="kpis" id="kpis">
          <span class="pill">/api/health: <span id="hStatus" class="badge b-warn">…</span></span>
          <span class="pill">/api/scan: <span id="sStatus" class="badge b-warn">…</span></span>
          <span class="pill">/api/simulate: <span id="mStatus" class="badge b-warn">…</span></span>
          <span class="pill">/api/bags/ping: <span id="pStatus" class="badge b-warn">…</span></span>
        </div>
        <div style="margin-top:12px">
          <pre id="healthOut" aria-live="polite">Clique em “Atualizar Status”.</pre>
        </div>
      </div>

      <!-- Playground -->
      <div class="card span-5">
        <h3>Playground Rápido</h3>
        <div class="row">
          <input id="mint" placeholder="mint (simulate)" />
          <button id="btnSim" class="btn btn-primary">POST /api/simulate</button>
        </div>
        <div class="row" style="margin-top:8px">
          <textarea id="tx" rows="5" placeholder='rawTransaction (scan) — cole um JSON bruto ou texto'></textarea>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnScan" class="btn btn-ghost">POST /api/scan</button>
          <button id="btnClear" class="btn btn-ghost">Limpar</button>
        </div>
        <div style="margin-top:12px">
          <pre id="outSim">{ }</pre>
          <div style="height:8px"></div>
          <pre id="outScan">{ }</pre>
        </div>
      </div>

      <!-- Andamento do Projeto -->
      <div class="card span-7">
        <h3>Andamento do Projeto</h3>
        <ul style="margin:8px 0 0 18px; line-height:1.6">
          <li>UI <strong>navy/blue</strong> publicada (esta página).</li>
          <li>Cliente <code>lib/bags.ts</code> com timeout + retry/backoff <em>(próximo passo)</em>.</li>
          <li>Ativar <code>/scan</code> e <code>/simulate</code> em modo <em>canário</em> usando o cliente.</li>
          <li>Docs v0 (schemas scan/simulate) — exemplos e smoke scripts.</li>
          <li>Rolling Releases/Skew Protection configuráveis no Vercel.</li>
        </ul>
      </div>

      <!-- Deploy & Metadados -->
      <div class="card span-5">
        <h3>Deploy & Metadados</h3>
        <div class="kv">
          <div class="ghost">RequestId</div><div id="kvReq">—</div>
          <div class="ghost">DeploymentId</div><div id="kvDep">—</div>
          <div class="ghost">Vercel-Id</div><div id="kvVer">—</div>
          <div class="ghost">RateLimit</div><div id="kvRl">—</div>
        </div>
      </div>
    </div>

    <div class="footer">© Bags Shield — navy/blue UI • CTAs verde neon • responsivo (430×932 / 1290×2796)</div>
  </div>

  <script>
    const $ = (q)=>document.querySelector(q);
    const fmt = (data)=>{ try{ return JSON.stringify(data, null, 2); }catch(e){ return String(data); } };
    async function safeJson(res){ try { return await res.json(); } catch { return { success:false, error:"Conteúdo não-JSON", text: await res.text() }; } }
    function badge(el, ok){ el.className = "badge " + (ok ? "b-ok" : "b-err"); el.textContent = ok ? "OK" : "ERRO"; }

    async function pingHealth(){
      $('#healthOut').textContent = "Consultando /api/health …";
      const res = await fetch('/api/health', { headers:{'Accept':'application/json'} }).catch(()=>null);
      if(!res){ $('#healthOut').textContent = "Falha de rede"; badge($('#hStatus'), false); return; }
      const body = await safeJson(res);
      $('#healthOut').textContent = fmt(body);
      badge($('#hStatus'), res.ok);

      // Metadados (RequestId preferindo body.meta, fallback header)
      const rid = (body && body.meta && (body.meta.requestId || body.meta.request_id)) || res.headers.get('x-request-id') || '—';
      $('#kvReq').textContent = rid;
      return res.ok;
    }

    async function pingBags(){
      const el = $('#pStatus'); el.textContent = "…"; el.className = "badge b-warn";
      const res = await fetch('/api/bags/ping', { headers:{'Accept':'application/json'} }).catch(()=>null);
      if(!res){ el.textContent="ERRO"; el.className="badge b-err"; return; }
      const body = await safeJson(res);
      el.textContent = res.ok ? "OK" : "ERRO";
      el.className = "badge " + (res.ok ? "b-ok" : "b-err");
      $('#healthOut').textContent = "Ping Bags (canário):\n" + fmt(body);
      // RateLimit meta vinda do proxy
      const m = (body && body.meta) || {};
      const rl = [m.rateLimitRemaining, m.rateLimitLimit].every(Boolean) ? `${m.rateLimitRemaining}/${m.rateLimitLimit} (reset ${m.rateLimitReset||'?'})` : '—';
      $('#kvRl').textContent = rl;
    }

    async function head(url){ const res = await fetch(url, { method:'HEAD' }).catch(()=>null); return res; }

    async function getDeployMeta(){
      const res = await head('/');
      if(!res) return;
      const dpl = res.headers.get('x-deployment-id') || '—';
      const ver = res.headers.get('x-vercel-id') || res.headers.get('server') || '—';
      $('#kvDep').textContent = dpl;
      $('#kvVer').textContent = ver;
    }

    async function checkEndpoints(){
      const okHealth = await pingHealth();
      const r1 = await head('/api/scan');   badge($('#sStatus'), !!(r1 && r1.ok));
      const r2 = await head('/api/simulate'); badge($('#mStatus'), !!(r2 && r2.ok));
      await getDeployMeta();
    }

    async function postJson(url, payload, out){
      out.textContent = "POST " + url + " …";
      try{
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(payload) });
        const body = await safeJson(res);
        out.textContent = fmt(body);
      }catch(e){ out.textContent = fmt({ success:false, error:String(e) }); }
    }

    $('#btnHealth').addEventListener('click', checkEndpoints);
    $('#btnPing').addEventListener('click', pingBags);
    $('#btnSim').addEventListener('click', ()=> postJson('/api/simulate', { mint: $('#mint').value.trim() }, $('#outSim')));
    $('#btnScan').addEventListener('click', ()=> postJson('/api/scan', { rawTransaction: $('#tx').value }, $('#outScan')));
    $('#btnClear').addEventListener('click', ()=>{ $('#outSim').textContent='{ }'; $('#outScan').textContent='{ }'; });

    checkEndpoints();
  </script>
</body>
</html>