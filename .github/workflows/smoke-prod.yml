name: ci(prod): fumaÃ§a condicional â€” health + token-info opcional
on:
  workflow_dispatch:
    inputs:
      RUN_TOKEN_INFO:
        description: 'Run token-info step?'
        required: false
        default: 'false'
      PROD_BASE_URL:
        description: 'Base URL override'
        required: false
        default: ''
  push:
    branches:
      - main
      - feat/v0-schemas-and-dev-server
jobs:
  smoke-prod:
    runs-on: windows-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Health (prod)
        shell: pwsh
        env:
          PROD_BASE_URL: ${{ vars.PROD_BASE_URL }}
        run: |
          $base = "${{ env.PROD_BASE_URL }}"
          if ([string]::IsNullOrWhiteSpace($base)) { $base = 'https://bags-shield-api.vercel.app' }
          Write-Host "Base = $base"
          $h = Invoke-RestMethod "$base/api/health" -TimeoutSec 10
          if (-not $h.ok) { throw "health not ok: $($h | ConvertTo-Json -Compress)" }
          Write-Host "HEALTH OK: $($h.ts)"

      - name: Token-info (opcional)
        if: ${{ inputs.RUN_TOKEN_INFO == 'true' && secrets.BAGS_API_BASE != '' }}
        shell: pwsh
        env:
          PROD_BASE_URL: ${{ vars.PROD_BASE_URL }}
          BAGS_API_BASE: ${{ secrets.BAGS_API_BASE }}
        run: |
          $base = "${{ env.PROD_BASE_URL }}"
          if ([string]::IsNullOrWhiteSpace($base)) { $base = 'https://bags-shield-api.vercel.app' }
          $resp = Invoke-WebRequest -Method GET -Uri "$base/api/bags/token-info" -TimeoutSec 15 -ErrorAction Stop
          if ($resp.StatusCode -ne 200) { throw "token-info HTTP $($resp.StatusCode)" }
          Write-Host "token-info 200"