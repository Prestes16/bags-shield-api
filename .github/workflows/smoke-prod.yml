name: ci(prod): fumaça condicional — leve
on:
  workflow_dispatch:

jobs:
  smoke-prod:
    runs-on: windows-latest
    # só roda se o secret existir
    if: ${{ secrets.BAGS_API_BASE != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Health check (prod)
        shell: pwsh
        run: |
          $base = '${{ vars.PROD_BASE_URL }}'
          if ([string]::IsNullOrWhiteSpace($base)) { $base = 'https://bags-shield-api.vercel.app' }
          Write-Host "Base = $base"
          $r = Invoke-RestMethod "$base/api/health" -TimeoutSec 10 -ErrorAction Stop
          if (-not $r.ok) { throw "health not ok" }
          Write-Host "HEALTH OK: $($r.ts)"

      - name: Token-info (condicional)
        # só roda se você ligar explicitamente via variável do repositório
        if: ${{ vars.RUN_TOKEN_INFO == 'true' }}
        shell: pwsh
        run: |
          $base = '${{ vars.PROD_BASE_URL }}'
          if ([string]::IsNullOrWhiteSpace($base)) { $base = 'https://bags-shield-api.vercel.app' }
          Write-Host "Base = $base"
          try {
            $resp = Invoke-WebRequest "$base/api/bags/token-info" -TimeoutSec 10 -ErrorAction Stop
            Write-Host "token-info HTTP $([int]$resp.StatusCode)"
            if ($resp.StatusCode -ne 200) { throw "token-info not 200" }
          } catch {
            Write-Host "::warning:: token-info falhou — provavelmente sem BAGS_API_BASE na Vercel. Pulando."
          }