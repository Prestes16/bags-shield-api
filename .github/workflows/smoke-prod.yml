name: ci(prod): fumaÃ§a (condicional + tolerante 501/NOT_CONFIGURED)
on:
  workflow_dispatch:
    inputs:
      RUN_TOKEN_INFO:
        description: 'Executa o passo /bags/token-info (requer secret BAGS_API_BASE)'
        required: false
        default: 'false'
      PROD_BASE_URL:
        description: 'Override da base URL (opcional)'
        required: false
        default: ''
  push:
    branches:
      - main
      - feat/v0-schemas-and-dev-server
jobs:
  smoke-prod:
    # SÃ³ roda se existir o secret (porta de seguranÃ§a),
    # mas o script abaixo trata 501/NOT_CONFIGURED como sucesso.
    if: ${{ secrets.BAGS_API_BASE != '' }}
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
      - name: Probe /api/bags/token-info (PS)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          # Base de prod: pode sobrescrever via Repository Variables (Settings > Variables)
          $base = '${{ vars.PROD_BASE_URL }}'
          if ([string]::IsNullOrWhiteSpace($base)) { $base = 'https://bags-shield-api.vercel.app' }
          $url  = "$base/api/bags/token-info"

          # RequisiÃ§Ã£o â€œÃ  prova de PS 5/7â€: HttpWebRequest captura 2xx/4xx/5xx sem explodir
          $enc = [System.Text.Encoding]::UTF8
          $req = [System.Net.HttpWebRequest]::Create($url)
          $req.Method = 'GET'
          $req.ContentLength = 0

<<<<<<< HEAD
          try {
            $resp = [System.Net.HttpWebResponse]$req.GetResponse()
          } catch [System.Net.WebException] {
            $resp = [System.Net.HttpWebResponse]$_.Exception.Response
          }
=======
          echo "::group::Warm-up /api/health"
          hc="000"; for i in $(seq 1 12); do
            hc=$(curl "${curl_opts[@]}" -o /dev/null -w '%{http_code}' "$alias/api/health" || echo 000)
            echo "try#$i health HTTP=$hc"
            [ "$hc" = "200" ] && break
            sleep 5
          done
          [ "$hc" = "200" ] || { echo "health != 200 apÃƒÂ³s retries"; exit 1; }
          echo "::endgroup::"
>>>>>>> 7777e76 (ci(prod): habilita workflow_dispatch e push na main (smoke-prod))

          if ($null -eq $resp) {
            Write-Host "Sem resposta do servidor â€” FAIL hard."
            exit 1
          }

<<<<<<< HEAD
          $code = [int]$resp.StatusCode
          $xrid = $resp.Headers['X-Request-Id']
          $sr   = New-Object System.IO.StreamReader($resp.GetResponseStream(), $enc)
          $body = $sr.ReadToEnd(); $sr.Close()
=======
          # AsserÃƒÂ§ÃƒÂµes finais (se chegou aqui, deve estar OK)
          ok=$(jq -r '.ok' body.txt)
          base=$(jq -r '.meta.baseUrlUsed' body.txt)
          test "$ok" = "true" || { echo "ok != true"; exit 1; }
          test "$base" = "$expect" || { echo "baseUrlUsed divergente: $base"; exit 1; }
>>>>>>> 7777e76 (ci(prod): habilita workflow_dispatch e push na main (smoke-prod))

          Write-Host "HTTP: $code"
          Write-Host "X-Request-Id: $xrid"

          # TolerÃ¢ncia: produÃ§Ã£o sem BAGS_API_BASE configurado ainda
          if ($code -eq 501 -and ($body -match 'NOT_CONFIGURED')) {
            Write-Host "BAGS_API_BASE nÃ£o configurado em produÃ§Ã£o â€” marcando como SUCESSO (skip suave)."
            exit 0
          }

          if ($code -ge 200 -and $code -lt 300) {
            Write-Host "OK 2xx â€” sucesso real."
            exit 0
          }

          Write-Host "Body (head):"
          $head = $body.Substring(0,[Math]::Min(500,$body.Length))
          Write-Host $head
          exit 1
