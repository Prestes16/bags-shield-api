name: ci(prod): fumaça (condicional + tolerante 501/NOT_CONFIGURED)

on:
  workflow_dispatch:

jobs:
  smoke-prod:
    # Só roda se existir o secret (porta de segurança),
    # mas o script abaixo trata 501/NOT_CONFIGURED como sucesso.
    if: ${{ secrets.BAGS_API_BASE != '' }}
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
      - name: Probe /api/bags/token-info (PS)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          # Base de prod: pode sobrescrever via Repository Variables (Settings > Variables)
          $base = '${{ vars.PROD_BASE_URL }}'
          if ([string]::IsNullOrWhiteSpace($base)) { $base = 'https://bags-shield-api.vercel.app' }
          $url  = "$base/api/bags/token-info"

          # Requisição “à prova de PS 5/7”: HttpWebRequest captura 2xx/4xx/5xx sem explodir
          $enc = [System.Text.Encoding]::UTF8
          $req = [System.Net.HttpWebRequest]::Create($url)
          $req.Method = 'GET'
          $req.ContentLength = 0

          try {
            $resp = [System.Net.HttpWebResponse]$req.GetResponse()
          } catch [System.Net.WebException] {
            $resp = [System.Net.HttpWebResponse]$_.Exception.Response
          }

          if ($null -eq $resp) {
            Write-Host "Sem resposta do servidor — FAIL hard."
            exit 1
          }

          $code = [int]$resp.StatusCode
          $xrid = $resp.Headers['X-Request-Id']
          $sr   = New-Object System.IO.StreamReader($resp.GetResponseStream(), $enc)
          $body = $sr.ReadToEnd(); $sr.Close()

          Write-Host "HTTP: $code"
          Write-Host "X-Request-Id: $xrid"

          # Tolerância: produção sem BAGS_API_BASE configurado ainda
          if ($code -eq 501 -and ($body -match 'NOT_CONFIGURED')) {
            Write-Host "BAGS_API_BASE não configurado em produção — marcando como SUCESSO (skip suave)."
            exit 0
          }

          if ($code -ge 200 -and $code -lt 300) {
            Write-Host "OK 2xx — sucesso real."
            exit 0
          }

          Write-Host "Body (head):"
          $head = $body.Substring(0,[Math]::Min(500,$body.Length))
          Write-Host $head
          exit 1
